<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HETAIROI - Session Control</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Roboto+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        /* Scrolling Fix */
        html,
        body {
            height: auto !important;
            min-height: 100vh;
            overflow-y: auto !important;
        }

        .main-container {
            height: auto !important;
            min-height: 100vh;
            overflow: visible !important;
            padding-bottom: 100px;
            /* Space for scrolling */
        }

        .session-content {
            height: auto !important;
            overflow: visible !important;
        }

        /* ... existing styles ... */

        .circle-container {
            /* Override default background for Pie Chart */
            background: conic-gradient(rgba(255, 255, 255, 0.05) 0deg 360deg);
            transition: background 0.5s ease;
            font-family: 'Cinzel', serif;
            font-weight: 700;
            /* Persistent Gold Border */
            border: 4px solid #D4AF37;
            border-radius: 50%;
            box-sizing: border-box;
        }

        .player-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform-origin: 0 0;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
            white-space: nowrap;
            /* Glowing Text Effect from Theme */
            text-shadow: 0 0 10px rgba(0, 242, 255, 0.8), 0 0 20px rgba(0, 242, 255, 0.4);
            pointer-events: none;
        }

        .slice-separator {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 50%;
            height: 1px;
            background: rgba(0, 242, 255, 0.3);
            transform-origin: 0 0;
            pointer-events: none;
        }


        /* Server Status Indicator */
        #server-status {
            position: fixed;
            top: 10px;
            left: 10px;
            padding: 5px 10px;
            border-radius: 15px;
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #333;
            color: #666;
            font-family: 'Roboto Mono', monospace;
            font-size: 0.8rem;
            z-index: 10001;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        #server-status.connected {
            border-color: #00ff00;
            color: #00ff00;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.2);
        }

        #server-status.disconnected {
            border-color: #ff0000;
            color: #ff0000;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: currentColor;
        }

        /* Pop Animation for Selected Labels */
        @keyframes popText {
            0% {
                transform: scale(1);
                text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            }

            50% {
                transform: scale(1.5);
                text-shadow: 0 0 30px rgba(255, 255, 255, 1);
                color: #fff;
            }

            100% {
                transform: scale(1.2);
                text-shadow: 0 0 20px rgba(255, 255, 255, 0.8);
                color: #fff;
            }
        }

        .pop-highlight {
            animation: popText 0.5s ease forwards;
            z-index: 100 !important;
        }

        /* Results List Container */
        #results-list {
            margin-top: 20px;
            width: 80%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 50;
        }

        .result-item {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 10px 20px;
            display: flex;
            justify-content: flex-start;
            /* Align start to control spacing manually */
            align-items: center;
            border-radius: 5px;
            font-family: 'Cinzel', serif;
            opacity: 0;
            animation: fadeIn 0.5s forwards;
        }

        .result-role {
            font-weight: bold;
            /* Badge Style */
            background: #000;
            padding: 5px 10px;
            border-radius: 4px;
            margin-right: 15px;
            /* Separation */
            min-width: 120px;
            /* Fixed width for alignment */
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .status-title {
            font-family: 'Cinzel', serif;
            font-size: 2.5rem;
            /* Adjusted to be prominent but not overwhelming */
            font-weight: 400;
            /* Match QR Code text weight */
            color: #ffffff;
            /* Match QR Code text color */
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 20px;
            text-shadow: none;
            /* Removed heavy glow */
            border-bottom: none;
            /* Removed border */
            padding-bottom: 0;
            display: inline-block;
            transition: opacity 1s ease, transform 1s ease;
            /* For smooth fade */
        }

        .fade-out-title {
            opacity: 0;
            transform: scale(0.9);
            /* Subtle shrink effect */
            pointer-events: none;
        }

        /* ... existing styles ... */

        .start-selection-plate {
            position: relative;
            width: 300px;
            height: 80px;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid #aaa;
            /* Hexagonal Shape / Chamfered Corners */
            clip-path: polygon(10% 0, 90% 0, 100% 50%, 90% 100%, 10% 100%, 0% 50%);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
        }

        .start-selection-plate:hover {
            background: rgba(40, 40, 40, 0.8);
            border-color: #fff;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        /* Inner Content Wrapper to create the "Double Border" effect visual */
        .start-selection-plate::before {
            content: '';
            position: absolute;
            top: 4px;
            left: 4px;
            right: 4px;
            bottom: 4px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            clip-path: polygon(10% 0, 90% 0, 100% 50%, 90% 100%, 10% 100%, 0% 50%);
            pointer-events: none;
        }

        .plate-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2;
        }

        .plate-title {
            font-family: 'Cinzel', serif;
            font-size: 1.2rem;
            color: #fff;
            letter-spacing: 2px;
            line-height: 1;
        }

        .plate-subtitle {
            font-family: 'Cinzel', serif;
            font-size: 1.4rem;
            /* Larger as per image */
            color: #fff;
            letter-spacing: 1px;
            line-height: 1;
        }

        .plate-line {
            width: 80%;
            height: 1px;
            background: linear-gradient(90deg, transparent, #aaa, transparent);
            margin: 2px 0;
        }

        .plate-screw {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 0 2px #000;
            z-index: 3;
        }

        /* Screw positions rough approx for chamfered edges */
        .plate-screw.top-left {
            top: 12%;
            left: 12%;
        }

        .plate-screw.top-right {
            top: 12%;
            right: 12%;
        }

        .plate-screw.bottom-left {
            bottom: 12%;
            left: 12%;
        }

        .plate-screw.bottom-right {
            bottom: 12%;
            right: 12%;
        }

        /* ACCESS CARD (QR & Code) */
        .access-card {
            position: absolute;
            top: 40px;
            left: 40px;
            width: 260px;
            /* Increased from 200px */
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #FFD700;
            padding: 25px;
            /* Slightly more padding */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            z-index: 100;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            transition: opacity 1s ease, transform 1s ease;
        }

        .qr-frame {
            width: 200px;
            /* Increased from 150px */
            height: 200px;
            /* Increased from 150px */
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.05);
            position: relative;
        }

        #qr-code-canvas {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
        }

        .qr-text {
            font-family: 'Cinzel', serif;
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.9rem;
            letter-spacing: 2px;
        }

        .session-code-display {
            font-family: 'Cinzel', serif;
            color: #FFD700;
            font-size: 1.2rem;
            letter-spacing: 2px;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        /* DASHBOARD TRANSITIONS */
        @keyframes implodeExit {
            0% {
                transform: scale(1);
                opacity: 1;
                filter: blur(0px);
            }

            100% {
                transform: scale(0.1) rotate(180deg);
                opacity: 0;
                filter: blur(20px);
            }
        }

        .implode-exit {
            animation: implodeExit 1.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
            pointer-events: none;
        }

        /* LOADING SPINNER */
        .spinner-ring {
            display: inline-block;
            width: 80px;
            height: 80px;
            border: 6px solid rgba(255, 215, 0, 0.3);
            border-radius: 50%;
            border-top-color: #FFD700;
            animation: spin 1s ease-in-out infinite;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.2);
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .status-card {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #444;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            min-width: 400px;
        }

        /* MISSING CSS FOR PLAYER LABELS */
        .player-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform-origin: 0 0;
            width: 0;
            height: 0;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            pointer-events: none;
            z-index: 50;
            /* Higher than hub (20) */
            white-space: nowrap;
            overflow: visible;
        }

        .circle-container {
            overflow: visible !important;
        }
    </style>
</head>

<body>
    <!-- Custom Animated Cursor -->
    <div id="custom-cursor" style="pointer-events: none;">
        <div class="cursor-ring"></div>
        <div class="cursor-dot"></div>
    </div>
    <canvas id="glCanvas" style="pointer-events: none;"></canvas>
    <div id="game-indicators" class="hidden">
        <div class="protest-container" style="width: 80%; margin: 20px auto; border: 2px solid #555; padding: 5px;">
            <div style="text-align: left; color: #aaa; margin-bottom: 5px;">CIVIL UNREST</div>
            <div style="background: #222; height: 30px; width: 100%;">
                <div id="protest-fill" style="background: #b30000; height: 100%; width: 0%; transition: width 0.2s;">
                </div>
            </div>
        </div>
    </div>
    <div class="main-container">
        <!-- Frame Elements -->
        <div class="frame" style="pointer-events: none;">
            <img src="assets/custom_frame_simple.svg" class="full-frame main-border" alt=""
                style="height: 95vh; width: 95vw; pointer-events: none;">
        </div>

        <div class="content session-content">

            <!-- SECTION 1: HEADER -->
            <header class="session-header hidden" id="game-header">
                <h1 class="session-title title-text" style="font-size: 2rem;">HETAIROI - Session Control</h1>
                <div class="session-status-bar">
                    <div class="status-item">
                        <span class="status-label">Round:</span>
                        <span class="status-value" id="display-round">-</span>
                    </div>
                    <span class="status-separator">|</span>
                    <div class="status-item">
                        <span class="status-label">Phase:</span>
                        <span class="status-value" id="display-phase">-</span>
                    </div>
                </div>
            </header>

            <!-- STAGE 1: SETUP SCREEN -->
            <div id="screen-setup" class="screen-section">
                <h2 class="prompt-text" style="font-family: 'Cinzel', serif;">Initialize Game Session</h2>
                <button id="btn-create-session" class="alchemy-btn"
                    style="width: 300px; margin: 20px auto; pointer-events: auto;">
                    <img src="assets/button_pro.svg" class="btn-bg" alt="">
                    <span class="btn-text">CREATE SESSION</span>
                </button>
            </div>

            <!-- STAGE 2: LOBBY SCREEN -->
            <div id="screen-lobby" class="screen-section hidden">

                <!-- NEW: ACCESS CARD (Top Left) -->
                <div class="access-card">
                    <div class="qr-frame" id="qr-code-container">
                        <span class="qr-text" id="qr-placeholder">QR CODE</span>
                        <canvas id="qr-code-canvas" width="200" height="200"
                            style="display: none; max-width: 100%; max-height: 100%;"></canvas>
                        <img id="qr-code-img"
                            style="display: none; max-width: 100%; max-height: 100%; width: 200px; height: 200px;"
                            alt="QR Code">
                    </div>
                    <div class="session-code-display">
                        CODE: <span id="display-code">----</span>
                    </div>
                </div>

                <div class="lobby-container">
                    <div class="lobby-status"
                        style="width: 100%; display: flex; flex-direction: column; align-items: center;">
                        <h2 class="status-title" style="font-family: 'Cinzel', serif;">Circle of Luck</h2>

                        <!-- Structure Refactor: Wrapper for positioning -->
                        <!-- Enlarged Size: 55vh -->
                        <div style="position: relative; width: 55vh; height: 55vh;">

                            <!-- Spinning Circle (Pie Chart) -->
                            <div id="circle-display" class="circle-container"
                                style="position: absolute; top:0; left:0; width:100%; height:100%; z-index: 10;">
                                <!-- Slices injected here -->
                            </div>

                            <!-- Static Center (Black Circle) -->
                            <!-- Dynamic Size: 22vh (Radius 11vh) -->
                            <div class="center-status"
                                style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 20; width: 22vh; height: 22vh;">
                                <span class="center-count" id="player-count">0</span>
                                <span class="center-label">JOINED</span>
                            </div>

                        </div>

                        <!-- Controls -->
                        <div class="control-panel"
                            style="margin-top: 30px; text-align: center; display: flex; justify-content: center;">
                            <!-- Removed 'Wait for Host' text as requested -->

                            <!-- Custom Start Selection Plate -->
                            <div id="btn-start-game" class="start-selection-plate" onclick="window.runAnimation()"
                                style="cursor: pointer;">
                                <div class="plate-content">
                                    <span class="plate-title">START</span>
                                    <div class="plate-line"></div>
                                    <span class="plate-subtitle">SELECTION</span>
                                </div>
                                <!-- Decorative Screws -->
                                <div class="plate-screw top-left"></div>
                                <div class="plate-screw top-right"></div>
                                <div class="plate-screw bottom-left"></div>
                                <div class="plate-screw bottom-right"></div>
                            </div>
                        </div>

                        <!-- Results List (Populated by JS) -->
                        <div id="results-list" class="results-container"
                            style="margin-top:20px; width: 80%; max-width: 600px;">
                            <!-- JS Injects items here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- STAGE 3: GAME DASHBOARD (HIDDEN) -->
            <div id="game-dashboard" class="screen-section hidden"
                style="width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding-top: 5vh;">

                <!-- 1. PROTEST METER (Top Center) -->
                <div class="protest-widget"
                    style="width: 60%; margin-bottom: 4vh; opacity: 0; transform: translateY(-20px); transition: all 1s ease;">
                    <h3
                        style="font-family: 'Cinzel', serif; color: #aaa; text-align: center; margin-bottom: 10px; letter-spacing: 3px;">
                        CIVIL UNREST</h3>
                    <div class="meter-frame"
                        style="height: 40px; border: 2px solid #555; background: #111; position: relative; border-radius: 4px; overflow: hidden;">
                        <div id="protest-bar"
                            style="width: 0%; height: 100%; background: linear-gradient(90deg, #500, #b30000); transition: width 0.5s cubic-bezier(0.25, 1, 0.5, 1); box-shadow: 0 0 20px #b30000;">
                        </div>
                        <div id="protest-percent"
                            style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #fff; font-family: 'Roboto Mono'; font-weight: bold; z-index: 2;">
                            0%</div>
                    </div>
                </div>

                <!-- 2. MAIN DISPLAY AREA (Middle) -->
                <div class="dashboard-main"
                    style="flex-grow: 1; width: 80%; display: flex; justify-content: center; align-items: center; position: relative;">

                    <!-- A. LEADER WAITING STATE -->
                    <div id="leader-status" class="status-card hidden" style="text-align: center;">
                        <div class="spinner-ring"></div>
                        <h2 style="font-family: 'Cinzel', serif; color: #FFD700; font-size: 2rem; margin-top: 20px;">
                            AWAITING LEADER DECREE</h2>
                        <p style="color: #aaa; font-family: 'Roboto Mono';">Allocating Resources...</p>
                    </div>

                    <!-- B. OUTCOME DISPLAY (Hidden) -->
                    <div id="outcome-display" class="outcome-card hidden">
                        <!-- Dynamic Content -->
                    </div>

                </div>

                <!-- 3. ELITE VOTES (Positioned by JS) -->
                <!-- Container will be created/positioned by drawEliteVotes() function -->

            </div>
            <div id="screen-game" class="screen-section hidden">
                <main class="session-main">
                    <div class="placeholder-dashboard">
                        <h3>Simulation Active</h3>
                </main>
            </div>

        </div>
    </div>


    <!-- Server Status Indicator -->
    <div id="server-status" class="disconnected">
        <div class="status-dot"></div>
        <span id="status-text">Disconnected</span>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script src="websocket-channel.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="game_engine.js"></script>
    <script src="background_anim.js"></script>
    <script>
        // Configure server URL
        window.GAME_SERVER_URL = 'https://dark-alchemy-server.onrender.com';

        // Status Monitor
        setInterval(() => {
            const statusEl = document.getElementById('server-status');
            const textEl = document.getElementById('status-text');
            if (window.engine && window.engine.channel && window.engine.channel.connected) {
                statusEl.className = 'connected';
                textEl.innerText = 'Connected';
            } else {
                statusEl.className = 'disconnected';
                textEl.innerText = 'Disconnected';
            }
        }, 1000);
    </script>
    <script>

        document.addEventListener('DOMContentLoaded', () => {
            // 1. Initialize Engine Immediately
            window.engine = new GameSession();

            // --- LOOPBACK SHIM ---
            const originalSend = window.engine.channel.send.bind(window.engine.channel);

            // Global Renderer
            window.handleUiUpdate = (msg) => {
                if (!msg) return;

                if (msg.type === 'STATE_UPDATE') {
                    // #region agent log
                    fetch('http://127.0.0.1:7242/ingest/337209b4-c064-4f4f-9d1d-83736bceeff3', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ location: 'session_control.html:566', message: 'Professor received STATE_UPDATE', data: { eventType: msg.type, playerCount: msg.playerCount, sessionCode: msg.sessionCode, round: msg.round, phase: msg.phase }, timestamp: Date.now(), sessionId: 'debug-session', runId: 'run1', hypothesisId: 'D,E' }) }).catch(() => { });
                    // #endregion
                    const rDisp = document.getElementById('display-round');
                    if (rDisp) rDisp.innerText = msg.round;

                    const pDisp = document.getElementById('display-phase');
                    if (pDisp) pDisp.innerText = msg.phase;

                    if (window.engine.state === 'ACTIVE') {
                        document.getElementById('game-header').classList.remove('hidden');
                        document.getElementById('screen-lobby').classList.add('hidden');
                        document.getElementById('game-indicators').classList.remove('hidden');
                    }

                    if (msg.phase === 'LOBBY' || msg.phase === 'SETUP' || window.engine.state === 'LOBBY') {
                        const cCode = document.getElementById('display-code');
                        if (cCode && window.engine.sessionCode) {
                            cCode.innerText = window.engine.sessionCode;
                            // Generate QR code - wait a bit to ensure DOM is ready
                            setTimeout(() => {
                                if (typeof QRCode !== 'undefined') {
                                    generateQRCode(window.engine.sessionCode);
                                } else {
                                    // Retry after library loads
                                    const checkQRCode = setInterval(() => {
                                        if (typeof QRCode !== 'undefined') {
                                            clearInterval(checkQRCode);
                                            generateQRCode(window.engine.sessionCode);
                                        }
                                    }, 100);
                                    // Stop checking after 5 seconds
                                    setTimeout(() => clearInterval(checkQRCode), 5000);
                                }
                            }, 200);
                        }

                        const pCount = document.getElementById('player-count');
                        if (pCount) pCount.innerText = window.engine.players.length;

                        renderPieChart(window.engine.players);
                    }
                }
            };

            // Override Send
            window.engine.channel.send = (data) => {
                originalSend(data);
                window.handleUiUpdate(data);
            };

            const uiChannel = new BroadcastChannel('dark_alchemy_session');
            uiChannel.onmessage = (e) => window.handleUiUpdate(e.data);

            // --- QR CODE GENERATOR ---
            function generateQRCode(sessionCode) {
                const qrContainer = document.getElementById('qr-code-container');
                const qrCanvas = document.getElementById('qr-code-canvas');
                const qrImg = document.getElementById('qr-code-img');
                const qrPlaceholder = document.getElementById('qr-placeholder');

                if (!qrContainer || !sessionCode) {
                    console.log('QR Code container not found or no session code:', { qrContainer: !!qrContainer, sessionCode });
                    return;
                }

                // Get the current page URL and add session code as parameter
                const currentUrl = window.location.origin + window.location.pathname.replace('session_control.html', 'player.html');
                const qrData = `${currentUrl}?code=${sessionCode}`;

                console.log('Generating QR code for:', qrData);

                // Primary method: Use QR code API (more reliable)
                if (qrImg) {
                    const apiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(qrData)}&color=FFFFFF&bgcolor=000000`;

                    qrImg.src = apiUrl;
                    qrImg.onload = function () {
                        if (qrPlaceholder) qrPlaceholder.style.display = 'none';
                        if (qrCanvas) qrCanvas.style.display = 'none';
                        qrImg.style.display = 'block';
                        console.log('QR Code generated successfully via API');
                    };
                    qrImg.onerror = function () {
                        console.error('Failed to load QR code image, trying canvas method');
                        // Fallback to canvas if API fails
                        tryCanvasMethod(qrData, qrCanvas, qrImg, qrPlaceholder);
                    };
                } else {
                    tryCanvasMethod(qrData, qrCanvas, qrImg, qrPlaceholder);
                }
            }

            // Fallback: Try canvas method
            function tryCanvasMethod(qrData, qrCanvas, qrImg, qrPlaceholder) {
                if (typeof QRCode !== 'undefined' && qrCanvas) {
                    try {
                        QRCode.toCanvas(qrCanvas, qrData, {
                            width: 200,
                            height: 200,
                            colorDark: '#FFFFFF',
                            colorLight: '#000000',
                            correctLevel: QRCode.CorrectLevel.H,
                            margin: 2
                        }, function (error) {
                            if (error) {
                                console.error('QR Code canvas error:', error);
                            } else {
                                if (qrPlaceholder) qrPlaceholder.style.display = 'none';
                                if (qrImg) qrImg.style.display = 'none';
                                qrCanvas.style.display = 'block';
                                console.log('QR Code generated successfully on canvas');
                            }
                        });
                    } catch (e) {
                        console.error('QR Code generation exception:', e);
                    }
                }
            }

            // --- PIE CHART RENDERER ---
            function renderPieChart(players) {
                const circle = document.getElementById('circle-display');
                if (!circle) return;

                circle.innerHTML = '';

                if (players.length === 0) {
                    circle.style.background = 'radial-gradient(circle, transparent 40%, rgba(0, 242, 255, 0.05) 70%)';
                    return;
                }

                const degPerSlice = 360 / players.length;
                let gradientStr = 'conic-gradient(';

                players.forEach((p, i) => {
                    const startDeg = i * degPerSlice;
                    const endDeg = (i + 1) * degPerSlice;
                    const midDeg = startDeg + (degPerSlice / 2);

                    // IDLE COLOR: Faint Neon Cyan 
                    let color = (i % 2 === 0) ? 'rgba(0, 242, 255, 0.1)' : 'rgba(0, 242, 255, 0.05)';

                    // REVEAL COLORS 
                    if (p.visualColor) color = p.visualColor;

                    gradientStr += `${color} ${startDeg}deg ${endDeg}deg, `;

                    const line = document.createElement('div');
                    line.className = 'slice-separator';
                    line.style.transform = `rotate(${endDeg}deg)`;
                    line.style.background = 'rgba(0, 242, 255, 0.3)';
                    circle.appendChild(line);

                    // 2. PLAYER LABEL (Outer)
                    const label = document.createElement('div');
                    label.className = 'player-label';

                    // Create inner span for text & animation to avoid transforming the container
                    const textSpan = document.createElement('span');
                    textSpan.innerText = p.name;
                    textSpan.style.display = 'inline-block'; // Needed for transform to work on span
                    label.appendChild(textSpan);

                    // CORRECTED RADIUS: 14vh
                    // Circle Radius: 27.5vh (55vh diam)
                    // Hub Radius: 11vh (22vh diam)
                    // Text Start: 14vh (3vh gap from hub)
                    // Available width: 13.5vh (fits most names)
                    label.style.transform = `rotate(${midDeg - 90}deg) translate(14vh)`;

                    label.style.textAlign = 'center';
                    label.style.color = '#fff';
                    // Base Glow
                    label.style.textShadow = '0 0 10px rgba(0, 242, 255, 0.8)';

                    // HIGHLIGHT POP EFFECT (For animating selections)
                    // Apply to inner span so we don't overwrite the rotation/translation of the parent
                    if (p.highlight) {
                        textSpan.classList.add('pop-highlight');
                    }
                    if (players.length > 20) label.style.fontSize = '0.7rem';

                    circle.appendChild(label);
                });

                gradientStr = gradientStr.slice(0, -2) + ')';
                circle.style.background = gradientStr;
                circle.style.boxShadow = '0 0 50px rgba(0, 242, 255, 0.15), inset 0 0 50px rgba(0,0,0,0.8)';
            }

            // --- ANIMATION ---
            window.runAnimation = async function () {
                const players = window.engine.players;
                if (players.length === 0) { alert("Add players first!"); return; }

                // Hide Title Smoothly
                const title = document.querySelector('.status-title');
                if (title) {
                    title.classList.add('fade-out-title');
                }

                // Hide Access Card Smoothly
                const accessCard = document.querySelector('.access-card');
                if (accessCard) {
                    accessCard.classList.add('fade-out-title');
                }

                // Clear Results List
                const list = document.getElementById('results-list');
                if (list) list.innerHTML = '';

                const circle = document.getElementById('circle-display');
                circle.style.animationDuration = '0.2s';

                // 1. FLICKER 
                for (let i = 0; i < 25; i++) {
                    const rndIdx = Math.floor(Math.random() * players.length);
                    players[rndIdx].visualColor = '#E0FFFF';
                    renderPieChart(players);
                    await new Promise(r => setTimeout(r, 60));
                    players[rndIdx].visualColor = null;
                }

                const mockRoles = players.map(p => ({ ...p }));
                const indices = mockRoles.map((_, i) => i).sort(() => Math.random() - 0.5);

                // Helper to add to list
                const addToList = (p, role, color) => {
                    const div = document.createElement('div');
                    div.className = 'result-item';
                    div.style.borderLeft = `5px solid ${color}`;
                    // CORRECTED ORDER: Role (Left, Colored) -> Name (Right, White)
                    div.innerHTML = `<span class="result-role" style="color:${color}; border-color:${color};">${role}</span><span class="result-name">${p.name}</span>`;
                    list.appendChild(div);
                    div.scrollIntoView({ behavior: 'smooth', block: 'end' });
                };

                // 2. LEADER (Neon Gold)
                const leaderIdx = indices[0];
                mockRoles[leaderIdx].visualColor = '#FFD700';
                mockRoles[leaderIdx].highlight = true; // POP
                renderPieChart(mockRoles);
                addToList(mockRoles[leaderIdx], "LEADER", "#FFD700");
                await new Promise(r => setTimeout(r, 1500));

                // 3. ELITES - Correct Roles from elite_preview.html
                // Roles: MILITARY, INTELLIGENCE, INTERIOR, ECONOMY, MEDIA
                const eliteRoles = [
                    { title: "MILITARY", color: "#b30000" },      // Blood Red
                    { title: "INTELLIGENCE", color: "#00bcd4" },  // Cyber Blue
                    { title: "INTERIOR", color: "#7b1fa2" },      // Deep Purple
                    { title: "ECONOMY", color: "#4caf50" },       // Money Green
                    { title: "MEDIA", color: "#ff9800" }          // Alert Orange
                ];

                const eliteIndices = indices.slice(1, 6);

                let roleIdx = 0;
                for (const idx of eliteIndices) {
                    if (mockRoles[idx]) {
                        const roleData = eliteRoles[roleIdx] || { title: "ELITE", color: "#BC13FE" };

                        mockRoles[idx].visualColor = roleData.color;
                        mockRoles[idx].highlight = true;

                        addToList(mockRoles[idx], roleData.title, roleData.color);
                        roleIdx++;

                        renderPieChart(mockRoles);
                        await new Promise(r => setTimeout(r, 1000));
                    }
                }

                // Final Delay
                await new Promise(r => setTimeout(r, 1000));

                // --- CHANGE BUTTON STATE ---
                const plate = document.getElementById('btn-start-game');
                if (plate) {
                    const subtitle = plate.querySelector('.plate-subtitle');
                    if (subtitle) subtitle.innerText = "GAME"; // Change text to START GAME

                    // Update Action
                    plate.onclick = function () {
                        if (window.startGame) window.startGame();
                    };

                    // Optional: Visual Cue that it's ready
                    plate.style.borderColor = '#FFD700';
                    plate.style.boxShadow = '0 0 30px rgba(255, 215, 0, 0.4)';
                }

                await new Promise(r => setTimeout(r, 500));

                // 4. CITIZENS
                indices.slice(6).forEach(idx => {
                    const citizenColor = '#00CED1';
                    if (mockRoles[idx]) mockRoles[idx].visualColor = citizenColor;
                });
                renderPieChart(mockRoles);

                circle.style.animationDuration = '60s';
                setTimeout(() => window.engine.startPhase('ALLOCATION'), 2000);
            };

            // --- START GAME TRANSITION ---
            window.startGame = async function () {
                console.log("Starting Game Transition...");

                const lobbyScreen = document.getElementById('screen-lobby');
                const dashboardScreen = document.getElementById('game-dashboard');
                const card = document.querySelector('.access-card');
                const title = document.querySelector('.status-title');

                // 1. Trigger Exit Animations (Implode)
                const lobbyContent = lobbyScreen.querySelector('.lobby-container');
                if (lobbyContent) lobbyContent.classList.add('implode-exit');

                if (card) {
                    card.style.transition = 'all 1s ease';
                    card.style.opacity = '0';
                    card.style.transform = 'scale(0.8)';
                }

                // 2. Wait for Animation
                await new Promise(r => setTimeout(r, 1500));

                // 3. Switch Screens
                lobbyScreen.classList.add('hidden');
                dashboardScreen.classList.remove('hidden');

                // 4. Reveal Dashboard Elements
                // Protest Meter
                const protestWidget = document.querySelector('.protest-widget');
                if (protestWidget) {
                    await new Promise(r => setTimeout(r, 200));
                    protestWidget.style.opacity = '1';
                    protestWidget.style.transform = 'translateY(0)';
                }

                // Leader Status (Center)
                const leaderStatus = document.getElementById('leader-status');
                if (leaderStatus) {
                    await new Promise(r => setTimeout(r, 500));
                    leaderStatus.classList.remove('hidden');
                    leaderStatus.animate([
                        { transform: 'scale(0.8)', opacity: 0 },
                        { transform: 'scale(1)', opacity: 1 }
                    ], { duration: 800, easing: 'cubic-bezier(0.175, 0.885, 0.32, 1.275)' });
                }

                console.log("Dashboard Active");
            };

            // Bindings
            const btnCreate = document.getElementById('btn-create-session');
            if (btnCreate) {
                btnCreate.onclick = () => {
                    document.getElementById('screen-setup').classList.add('hidden');
                    document.getElementById('screen-lobby').classList.remove('hidden');
                    window.engine.startLobby();

                    // Generate QR code after lobby is shown
                    setTimeout(() => {
                        if (window.engine && window.engine.sessionCode) {
                            const cCode = document.getElementById('display-code');
                            if (cCode) {
                                cCode.innerText = window.engine.sessionCode;
                            }
                            // Wait for QRCode library to load
                            if (typeof QRCode !== 'undefined') {
                                generateQRCode(window.engine.sessionCode);
                            } else {
                                // Retry after library loads
                                const checkQRCode = setInterval(() => {
                                    if (typeof QRCode !== 'undefined') {
                                        clearInterval(checkQRCode);
                                        generateQRCode(window.engine.sessionCode);
                                    }
                                }, 100);
                                setTimeout(() => clearInterval(checkQRCode), 5000);
                            }
                        }
                    }, 300);
                };
            }

            const btnStart = document.getElementById('btn-start-game');
            if (btnStart) btnStart.onclick = window.runAnimation;

            // Initialize session code display and QR code when session starts
            // Wait a bit for DOM to be ready and QRCode library to load
            setTimeout(() => {
                if (window.engine && window.engine.sessionCode) {
                    const cCode = document.getElementById('display-code');
                    if (cCode) {
                        cCode.innerText = window.engine.sessionCode;
                        // Wait for QRCode library to be available
                        if (typeof QRCode !== 'undefined') {
                            generateQRCode(window.engine.sessionCode);
                        } else {
                            // Retry after a short delay
                            setTimeout(() => generateQRCode(window.engine.sessionCode), 500);
                        }
                    }
                }
            }, 100);

            // Force first render
            // First render
            window.handleUiUpdate({ type: 'STATE_UPDATE', phase: 'SETUP', round: 0 });
        });



        // --- ELITE VOTES VISUALIZATION ---
        function drawEliteVotes(votes) {
            let container = document.getElementById('elite-votes-container');
            const main = document.querySelector('.dashboard-main');

            // Auto-create if missing
            if (!container) {
                if (main) {
                    container = document.createElement('div');
                    container.id = 'elite-votes-container';
                    main.appendChild(container);
                } else return;
            }

            // Ensure parent has relative positioning
            if (main) {
                main.style.position = 'relative';
            }

            // Set positioning and sizing - Right side, upper portion
            container.style.position = 'absolute';
            container.style.right = '2vw'; // Further right to create space
            container.style.top = '15%'; // Upper portion to match left chart and leave room below
            container.style.width = '350px';
            container.style.maxWidth = '350px';
            container.style.zIndex = '10';
            container.style.display = 'flex';
            container.style.flexDirection = 'column';
            container.style.alignItems = 'center';
            container.style.background = 'rgba(0, 0, 0, 0.7)';
            container.style.border = '1px solid rgba(255, 215, 0, 0.3)';
            container.style.borderRadius = '8px';
            container.style.padding = '20px';
            container.style.boxShadow = '0 0 30px rgba(0, 0, 0, 0.8)';
            container.style.transform = 'translateY(0)'; // No vertical centering, just top positioning

            container.innerHTML = '';

            // Animation Setup - just fade in
            container.style.opacity = '0';
            container.style.transition = 'opacity 0.5s ease';

            // Title
            const title = document.createElement('h2');
            title.style.fontFamily = "'Cinzel', serif";
            title.style.color = "#888";
            title.style.fontSize = "1.2rem";
            title.style.marginBottom = "20px";
            title.style.letterSpacing = "3px";
            title.innerText = "COUNCIL VOTES";
            container.appendChild(title);

            // Votes List 
            const list = document.createElement('div');
            list.style.display = 'flex';
            list.style.flexDirection = 'column';
            list.style.gap = '10px';
            list.style.width = '100%';
            list.style.padding = '20px';
            list.style.border = '1px solid rgba(255,215,0,0.3)';
            list.style.background = 'rgba(0,0,0,0.6)';

            votes.forEach((v, i) => {
                const row = document.createElement('div');
                row.style.background = 'rgba(255,255,255,0.05)';
                row.style.padding = '12px 15px';
                row.style.display = 'flex';
                row.style.justifyContent = 'space-between';
                row.style.alignItems = 'center';
                row.style.borderLeft = `4px solid ${v.color}`;
                row.style.opacity = '0';
                row.style.transform = 'translateX(30px)';
                row.style.transition = `all 0.5s ease ${i * 0.15 + 0.5}s`;

                const role = document.createElement('span');
                role.innerText = v.role;
                role.style.fontFamily = "'Cinzel', serif";
                role.style.color = "#e0e0e0";
                role.style.fontSize = "0.85rem";

                const status = document.createElement('span');
                status.style.fontFamily = "'Roboto Mono', monospace";
                status.style.fontWeight = "bold";
                status.style.fontSize = "0.9rem";

                if (v.vote === 'LOYAL') {
                    status.innerText = "LOYAL";
                    status.style.color = "#4CAF50";
                } else if (v.vote === 'BETRAY') {
                    status.innerText = "BETRAY";
                    status.style.color = "#d32f2f";
                } else {
                    status.innerText = "ABSTAIN";
                    status.style.color = "#888";
                }

                row.appendChild(role);
                row.appendChild(status);
                list.appendChild(row);

                requestAnimationFrame(() => {
                    setTimeout(() => {
                        row.style.opacity = '1';
                        row.style.transform = 'translateX(0)';
                    }, 50);
                });
            });
            container.appendChild(list);
            setTimeout(() => {
                container.style.opacity = '1';
            }, 100);
        }

        // --- DEBUG CONTROLS ---
        window.debugSteps = {
            addPlayers: () => {
                const names = ["Marcus", "Lucius", "Helena", "Titus", "Felix", "Octavia", "Brutus", "Cassius"];
                names.forEach((n, i) => window.engine.addPlayer(`p${i}`, n));
                console.log("Debug: Added Mock Players");
            },
            triggerSelection: () => {
                window.runAnimation();
            },
            triggerGame: () => {
                window.startGame();
            },
            testProtest: () => {
                const bar = document.getElementById('protest-bar');
                const txt = document.getElementById('protest-percent');
                let w = parseInt(bar.style.width) || 0;
                w = Math.min(w + 10, 100);
                bar.style.width = w + '%';
                txt.innerText = w + '%';

                // Shake Effect
                const widget = document.querySelector('.protest-widget');
                widget.style.transform = `translate(${Math.random() * 10 - 5}px, ${Math.random() * 10 - 5}px)`;
                setTimeout(() => widget.style.transform = 'translate(0,0)', 200);
            },
            testVoteReveal: () => {
                const mockVotes = [
                    { role: "MILITARY", vote: "LOYAL", color: "#b30000" },
                    { role: "INTELLIGENCE", vote: "BETRAY", color: "#00bcd4" },
                    { role: "INTERIOR", vote: "LOYAL", color: "#7b1fa2" },
                    { role: "ECONOMY", vote: "LOYAL", color: "#4caf50" },
                    { role: "MEDIA", vote: "BETRAY", color: "#ff9800" }
                ];
                drawEliteVotes(mockVotes);
            },
            testLeaderReveal: () => {
                // Mock Data matching Player Dashboard categories
                const mockAlloc = [
                    { label: "LEADER", value: 10, color: "#FFD700" },
                    { label: "MILITARY", value: 15, color: "#b30000" },
                    { label: "INTEL", value: 10, color: "#00bcd4" },
                    { label: "INTERIOR", value: 10, color: "#7b1fa2" },
                    { label: "ECONOMY", value: 15, color: "#4caf50" },
                    { label: "MEDIA", value: 10, color: "#ff9800" },
                    { label: "UPPER", value: 10, color: "#aaa" },
                    { label: "MIDDLE", value: 10, color: "#888" },
                    { label: "LOWER", value: 10, color: "#555" }
                ];
                drawBudgetBars(mockAlloc);
            }
        };
    </script>

</body>

</html>