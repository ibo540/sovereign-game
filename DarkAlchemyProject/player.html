<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HETAIROI - Player Entry</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700;900&family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400&display=swap"
        rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Roboto+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        /* Specific Styles for Player Login Panel */
        .player-form {
            display: flex;
            flex-direction: column;
            gap: 2vh;
            width: 80%;
            max-width: 450px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 8px;
            padding: 40px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.8), inset 0 0 40px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
        }

        .input-field {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid #ffd700;
            color: white;
            padding: 18px;
            font-family: 'Roboto Mono', monospace;
            text-align: center;
            font-size: 1.2rem;
            border-radius: 4px;
            transition: all 0.3s ease;
            letter-spacing: 2px;
        }

        .input-field:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            background: rgba(0, 0, 0, 0.8);
        }

        .input-field::placeholder {
            color: rgba(255, 255, 255, 0.4);
            letter-spacing: 1px;
        }

        .wait-message {
            text-align: center;
            color: #ffd700;
            font-family: 'Cinzel', serif;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 0.6;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.6;
            }
        }
    </style>
</head>

<body>
    <!-- Custom Animated Cursor -->
    <div id="custom-cursor">
        <div class="cursor-ring"></div>
        <div class="cursor-dot"></div>
    </div>
    <canvas id="glCanvas"></canvas>
    <div class="main-container">
        <!-- Frame Elements -->
        <div class="frame">
            <img src="assets/WindowFrame_5.svg" class="full-frame main-border" alt="">
        </div>

        <div class="content session-content">
            <h1 class="session-title">HETAIROI</h1>

            <!-- STAGE 1: LOGIN -->
            <div id="player-login" class="screen-section" style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh;">
                <h2 class="prompt-text" style="font-family: 'Cinzel', serif; font-size: 2.5vw; color: #ffd700; margin-bottom: 4vh; text-shadow: 0 0 20px rgba(255, 215, 0, 0.5); letter-spacing: 3px;">Join Session</h2>
                <form class="player-form" id="join-form" onsubmit="event.preventDefault(); joinSession(); return false;">
                    <input type="text" id="input-code" class="input-field" placeholder="SESSION CODE" maxlength="4"
                        style="text-transform:uppercase;" required autocomplete="off">
                    <input type="text" id="input-name" class="input-field" placeholder="YOUR NAME" maxlength="12" required autocomplete="off">
                    <button type="submit" id="btn-join" class="alchemy-btn" style="width: 100%; max-width: 100%; margin-top: 2vh; height: 60px; -webkit-tap-highlight-color: transparent;">
                        <img src="assets/button_pro.svg" class="btn-bg" alt="">
                        <span class="btn-text">ENTER</span>
                    </button>
                    <p id="error-msg" style="color:#ff3333; display:none; margin-top: 1.5vh; font-family: 'Roboto Mono', monospace; text-align: center; font-size: 0.9rem; letter-spacing: 1px;">Invalid Code</p>
                </form>
            </div>

            <!-- STAGE 2: WAITING LOBBY -->
            <div id="player-waiting" class="screen-section hidden">
                <h2 class="prompt-text">Connected</h2>
                <div class="wait-message">
                    <p>WAITING FOR PROFESSOR...</p>
                    <br>
                    <p style="font-size: 0.8em; font-family: 'Roboto Mono'; color: #888;">Do not close this window</p>
                </div>
            </div>

            <!-- STAGE 3: GAME ACTIVE -->
            <div id="player-dash" class="screen-section hidden">
                <div class="placeholder-dashboard">
                    <h3>Role Assigned</h3>
                    <div id="role-display">Waiting for assignment...</div>
                    <div id="role-content"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Script to connect to Game Engine via BroadcastChannel -->
    <!-- ELITE MODALS & EXTRA SCREENS -->

    <!-- WAITING SCREEN (Elite) -->
    <div id="waiting-screen-elite"
        style="display: none; flex-direction: column; align-items: center; justify-content: center; position: fixed; top:0; left:0; width:100%; height:100%; background:black; z-index:900; animation: fadeIn 1s;">
        <div class="status-ring"
            style="width: 80px; height: 80px; border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid var(--elite-color, #fff); border-radius: 50%; animation: spin 2s linear infinite;">
        </div>
        <h2
            style="color: var(--elite-color, #fff); margin-top: 30px; letter-spacing: 2px; font-family: 'Cinzel', serif;">
            VOTE RECORDED</h2>
        <p style="color: #aaa; font-family: 'Roboto Mono'; font-size: 0.9rem;">Awaiting Council Consensus...</p>
    </div>

    <!-- OUTCOME: COUP VICTORY -->
    <div id="outcome-victory" class="outcome-screen"
        style="position:fixed; top:0; left:0; width:100%; height:100%; background:black; z-index:950; justify-content:center;">
        <h1 class="outcome-header" style="color: var(--elite-color, #fff);">REGIME TOPPLED</h1>
        <p class="outcome-desc">
            The Leader has been overthrown. A new order rises from the ashes.
        </p>
        <button class="btn-lobby" onclick="location.reload()">PROCEED TO NEW ERA</button>
    </div>

    <!-- OUTCOME: PURGED (Failed Betrayal) -->
    <div id="outcome-purged" class="outcome-screen"
        style="position:fixed; top:0; left:0; width:100%; height:100%; background:black; z-index:950; justify-content:center;">
        <h1 class="outcome-header" style="color: #ff0000; font-size: 3rem;">ELIMINATED</h1>
        <p class="outcome-desc" style="color: #888;">
            Your betrayal was discovered. The Leader has shown no mercy.<br>
            <br>
            <span style="border: 1px solid #ff0000; padding: 5px; color: #ff0000;">CONNECTION TERMINATED</span>
        </p>
        <p style="font-size: 0.8rem; color: #555;">Thank you for participating. You have been removed from the session.
        </p>
    </div>

    <!-- OUTCOME: PARDONED (Failed Betrayal) -->
    <div id="outcome-pardoned" class="outcome-screen"
        style="position:fixed; top:0; left:0; width:100%; height:100%; background:black; z-index:950; justify-content:center;">
        <h1 class="outcome-header" style="color: #fff;">MERCY GRANTED</h1>
        <p class="outcome-desc">
            The revolt failed, but the Leader has chosen to spare you.<br>
            Do not squander this second chance.
        </p>
        <button class="btn-lobby" style="border-color:#fff; color:#fff; opacity:1;" onclick="goToLobby()">RETURN TO
            COUNCIL</button>
    </div>

    <!-- OUTCOME: STATUS QUO (Loyal) -->
    <div id="outcome-statusquo" class="outcome-screen"
        style="position:fixed; top:0; left:0; width:100%; height:100%; background:black; z-index:950; justify-content:center;">
        <h1 class="outcome-header" style="color: var(--elite-color, #fff);">ORDER MAINTAINED</h1>
        <p class="outcome-desc">
            The Leader remains in power. Your loyalty has been noted.
        </p>
        <button class="btn-lobby" style="opacity:1;" onclick="goToLobby()">PROCEED TO ROUND 2</button>
    </div>

    <!-- EXTERNAL OFFER MODAL (SCARY REDESIGN) -->
    <div id="external-offer-modal" style="z-index: 2000;">
        <div class="dossier">
            <h3
                style="font-family:'Cinzel'; color:#ff0000; margin-bottom:10px; font-size: 1.5rem; text-shadow: 0 0 10px #f00;">
                PATTERN DETECTED</h3>
            <p style="font-family:'Roboto Mono'; font-size:0.9rem; color:#aaa; line-height:1.6; margin-bottom:20px;">
                Secure channel established. A shadow faction is funnelling resources to destabilize the regime.
                <br><br>
                <span style="color:#fff;">Current Offer:</span> <strong style="color:#ff3d00;">+50 STATE
                    RESOURCES</strong>
            </p>
            <div style="background:rgba(50,0,0,0.3); border:1px solid #800; padding:15px; margin-bottom:25px;">
                <p style="margin:0; font-size:0.75rem; color:#888; letter-spacing: 2px;">REQUIRED ACTION:</p>
                <p style="margin:5px 0 0 0; font-size:1.1rem; color:#f00; font-family:'Cinzel'; font-weight:bold;">
                    BETRAY THE LEADER</p>
            </div>

            <button class="danger-btn" onclick="requestVote('EXTERNAL')">ACCEPT & OVERTHROW</button>
            <button class="burn-btn" onclick="document.getElementById('external-offer-modal').style.display='none'">[
                BURN MESSAGE ]</button>
        </div>
    </div>

    <!-- CONFIRMATION MODAL (Generic) -->
    <div id="confirmation-modal" style="display:none; z-index: 3000;">
        <div class="confirm-box" id="confirm-box-content">
            <h3 id="confirm-title" style="color: #fff; font-size: 1.4rem; margin-bottom: 20px; font-family:'Cinzel';">
                CONFIRM DECISION</h3>
            <p id="confirm-desc"
                style="color: #ccc; font-family:'Roboto Mono'; font-size: 0.9rem; margin-bottom: 30px; line-height: 1.5;">
                Are you sure you want to proceed with this action? This cannot be undone.
            </p>
            <button class="btn-vote" id="confirm-yes-btn" style="width:100%; margin-bottom: 10px;"
                onclick="confirmAction()">CONFIRM</button>
            <button class="burn-btn"
                onclick="document.getElementById('confirmation-modal').style.display='none'">CANCEL</button>
        </div>
    </div>

    <script>
        // --- Robust Communication Class for local file:// support ---
        class DualChannel {
            constructor(channelName, onMessage) {
                this.name = channelName;
                this.onMessage = onMessage;

                // 1. BroadcastChannel
                if (window.BroadcastChannel) {
                    this.bc = new BroadcastChannel(channelName);
                    this.bc.onmessage = (ev) => this.input(ev.data);
                }

                // 2. LocalStorage Fallback
                this.key = `DA_MSG_${channelName}`;
                window.addEventListener('storage', (ev) => {
                    if (ev.key === this.key && ev.newValue) {
                        try {
                            const data = JSON.parse(ev.newValue);
                            this.input(data);
                        } catch (e) { console.error("Comms Parse Error", e); }
                    }
                });
            }

            send(data) {
                if (this.bc) this.bc.postMessage(data);
                // LS Send
                const payload = JSON.stringify(data);
                localStorage.setItem(this.key, payload);
                // Toggle helper key to force event if payload identical
                localStorage.setItem(this.key + '_TOGGLE', Date.now());
            }

            input(data) {
                if (this.onMessage) this.onMessage(data);
            }
        }

        // --- Core Player Logic ---
        const channel = new DualChannel('dark_alchemy_session', handleMessage);

        let myName = '';
        let myRole = '';
        let myCode = '';

        // UI References
        const screenLogin = document.getElementById('player-login');
        const screenWait = document.getElementById('player-waiting');
        const screenDash = document.getElementById('player-dash');
        const inputCode = document.getElementById('input-code');
        const inputName = document.getElementById('input-name');
        const btnJoin = document.getElementById('btn-join');
        const errorMsg = document.getElementById('error-msg');

        // Auto-fill session code from URL parameter
        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const codeParam = urlParams.get('code');
            if (codeParam && inputCode) {
                inputCode.value = codeParam.toUpperCase();
            }
        });

        // Handle both click and touch events for mobile
        if (btnJoin) {
            btnJoin.onclick = (e) => {
                e.preventDefault();
                joinSession();
            };
            btnJoin.ontouchstart = (e) => {
                e.preventDefault();
                joinSession();
            };
        }

        // Handle Enter key press on inputs
        if (inputCode) {
            inputCode.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    inputName.focus();
                }
            });
        }

        if (inputName) {
            inputName.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    joinSession();
                }
            });
        }

        // Handle form submission
        const joinForm = document.getElementById('join-form');
        if (joinForm) {
            joinForm.addEventListener('submit', (e) => {
                e.preventDefault();
                joinSession();
                return false;
            });
        }

        function joinSession() {
            const code = document.getElementById('input-code').value.toUpperCase();
            const name = document.getElementById('input-name').value.trim();

            if (!code || !name) {
                const errorMsg = document.getElementById('error-msg');
                if (errorMsg) {
                    errorMsg.innerText = "Code and Name required!";
                    errorMsg.style.display = 'block';
                }
                return;
            }

            myCode = code;
            myName = name;

            // Visual Feedback (simplified for this context, original had more)
            // document.getElementById('entry-screen').innerHTML = `
            //     <h2>Connecting...</h2>
            //     <div class="loader"></div>
            //     <p>Wait for Lobby...</p>
            // `;

            // Send Join Request
            channel.send({ type: 'JOIN_REQUEST', code: code, name: name });
        }

        function handleMessage(msg) {
            if (!msg) return;
            console.log("Received:", msg);

            if (msg.type === 'JOIN_SUCCESS' && msg.name === myName) {
                // Login Successful
                screenLogin.classList.add('hidden');
                screenWait.classList.remove('hidden');
            } else if (msg.type === 'ROUND_RESULT') {
                document.body.classList.remove('leader-mode'); // Reset by default, re-add if leader

                // Case 1: Leader Victory
                // Note: Logic assumes msg.success means "Regime Survived" for Leader
                if (myRole === 'leader' && msg.success) {
                    document.body.classList.add('leader-mode');
                    // ... (Leader Victory Logic Omitted for brevity, unchanged) ...
                    // Dynamic Purged List
                    let listHtml = "";
                    if (msg.purged && msg.purged.length > 0) {
                        listHtml = msg.purged.map(name => `
                            <div class="traitor-card executed" style="border-color:#b30000; opacity:0.7;">
                                <div class="traitor-info"><span class="traitor-name">${name.toUpperCase()}</span><span class="traitor-role">Traitor</span></div>
                                <div class="action-buttons"><div style="color:red; font-weight:bold; width:100%; text-align:center; font-family:'Cinzel';">PURGED</div></div>
                            </div>
                        `).join('');
                    } else {
                        listHtml = `<p style="color:#4CAF50; font-style:italic; margin-top:20px; font-family:'Cinzel';">Total Loyalty Achieved.</p>`;
                    }

                    document.getElementById('role-content').innerHTML = `
                        <div class="screen-container" id="main-content">
                             <div class="victory-icon">♛</div>
                             <h1>REGIME SECURED</h1>
                             <p class="sub-text">Rebellion Crushed</p>
                             <div class="stat-box">
                                 <div class="stat"><span class="stat-label">Loyalist Support</span><span class="stat-val" style="color:#4CAF50">${msg.stats.loyal || '65'}%</span></div>
                                 <div class="stat"><span class="stat-label">Rebel Threat</span><span class="stat-val" style="color:#ff3333">${msg.stats.betray || '35'}%</span></div>
                             </div>
                             <div class="judgment-section">
                                 <div class="judgment-title">TRAITORS ELIMINATED</div>
                                 ${listHtml}
                                 <button class="btn-continue" id="btn-next" onclick="goToLobby()">PROCEED TO NEXT ROUND</button>
                             </div>
                        </div>`;
                }
                // Case 2: Leader Defeat
                else if (myRole === 'leader' && !msg.success) {
                    // ... (Leader Defeat Logic Omitted, unchanged) ...
                    document.body.classList.add('leader-mode');
                    document.getElementById('role-content').innerHTML = `
                        <div class="screen-container">
                            <div class="crack c1"></div><div class="crack c2"></div>
                            <div class="icon-dead">☠</div><h1>REGIME FALLEN</h1><p class="sub-text">Coup Successful</p>
                            <div class="defeat-msg">"The Leader has been detained. A new era begins."</div>
                        </div>`;
                    setTimeout(() => {
                        document.body.className = 'game-over-body';
                        document.getElementById('role-content').innerHTML = `<div class="game-over-container" style="animation: fadeInSlow 3s forwards; opacity:0;"><div class="icon-final">❖</div><h1>YOUR REIGN HAS ENDED</h1><p>History is written by the victors...</p><button onclick="window.location.reload()" style="margin-top:40px; background:transparent; border:1px solid #555; color:#888; padding:10px 20px;">RESTART SIMULATION</button></div>`;
                    }, 5000);
                }
                // Case 3: Everyone Else (Elites & Citizens)
                else {
                    // Check if Citizen
                    const citizen = msg.roles.citizens && msg.roles.citizens.find(c => c.name === myName);

                    if (citizen) {
                        // Citizen Outcome Logic
                        const activeUI = document.getElementById('citizen-active-interface');
                        const waitingUI = document.getElementById('waiting-screen');
                        if (activeUI) activeUI.style.display = 'none';
                        if (waitingUI) waitingUI.style.display = 'none'; // Ensure waiting screen is gone

                        // logic: 
                        // If Regime Won (msg.success):
                        //    - If I Protested: ELIMINATED (Purged)
                        //    - If I Accepted: VICTORY (Loyal)
                        // If Regime Lost (!msg.success):
                        //    - REVOLUTION (Tyrant Fallen)

                        if (msg.success) {
                            if (window.myProtestStatus === 'protest') {
                                document.getElementById('result-purged').style.display = 'flex';
                            } else {
                                document.getElementById('result-victory').style.display = 'flex';
                            }
                        } else {
                            document.getElementById('result-revolution').style.display = 'flex';
                        }
                    } else {
                        // Elite Outcome Logic
                        // Hide Dashboard / Waiting
                        document.getElementById('role-content').style.display = 'none';
                        document.getElementById('waiting-screen-elite').style.display = 'none';
                        document.getElementById('coup-options').style.display = 'none';
                        document.getElementById('external-offer-modal').style.display = 'none';

                        if (msg.success) {
                            // Leader Won (Regime Secured)
                            // Check if I was loyal or betrayed (need status from msg?)
                            // Assuming backend sends: msg.purged = ['Name1'] or msg.outcomes[myName]

                            const isPurged = msg.purged && msg.purged.includes(myName);
                            const isPardoned = msg.pardoned && msg.pardoned.includes(myName);

                            if (isPurged) {
                                document.getElementById('outcome-purged').style.display = 'flex';
                            } else if (isPardoned) {
                                document.getElementById('outcome-pardoned').style.display = 'flex';
                            } else {
                                // Default to loyal/status quo if not purged or pardoned
                                document.getElementById('outcome-statusquo').style.display = 'flex';
                            }
                        } else {
                            // Leader Lost (Coup Success)
                            document.getElementById('outcome-victory').style.display = 'flex';
                        }
                    }
                }
            } else if (msg.type === 'CHAT_MESSAGE') {
                const chatBox = document.getElementById('chat-messages');
                // Only act if chat box exists (Elite Dashboard Active)
                if (chatBox) {
                    // Don't duplicate if I sent it (optimistic update handled already)
                    if (msg.sender !== myName) {
                        const newLine = document.createElement('div');
                        newLine.style.marginBottom = '5px';
                        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        // Color sender if possible (or just white/grey)
                        newLine.innerHTML = `<span style="color: #aaa; font-size:0.7em;">${time}</span> <span style="color: #fff; font-weight: bold;">[${msg.sender.toUpperCase()}]:</span> ${msg.text}`;
                        chatBox.appendChild(newLine);
                        chatBox.scrollTop = chatBox.scrollHeight;
                    }
                }
            } else if (msg.type === 'COUP_ALERT') {
                const chatBox = document.getElementById('chat-messages');
                if (chatBox) {
                    const alertMsg = document.createElement('div');
                    alertMsg.className = 'chat-alert';
                    alertMsg.innerHTML = `
                        <div style="font-weight:bold; color:#ff0000; margin-bottom:3px; animation: flashRed 1s infinite alternate;">⚠ COUP DECLARED</div>
                        <div style="font-size:0.85em; color:#ccc;">Initiator: <span style="color:#fff">${msg.initiator}</span></div>
                        <div style="font-size:0.85em; color:#ccc;">Nominee: <span style="color:var(--elite-color)">${msg.candidate.toUpperCase()}</span></div>
                        <div style="margin-top:5px; display:flex; gap:10px;">
                            <button class="support-btn" style="flex:1;" onclick="confirmSupport('${msg.candidate}')">SUPPORT REVOLUTION</button>
                            <button style="flex:1;" onclick="this.parentElement.parentElement.remove()">IGNORE</button>
                        </div>
                    `;
                    chatBox.appendChild(alertMsg);
                    chatBox.scrollTop = chatBox.scrollHeight;
                }
            } else if (msg.type === 'STATE_UPDATE') {
                // Game Update
                screenWait.classList.add('hidden');
                screenDash.classList.remove('hidden');

                // Find My Role
                let myRoleText = "Unknown";
                let myDetail = "";

                if (msg.roles.leader === myName) {
                    myRoleText = "LEADER";
                    myDetail = "Allocating Resources...";

                    // Activate Leader Mode Styles
                    document.body.classList.add('leader-mode');

                    // Render Allocation Dashboard if in ALLOCATION phase
                    if (msg.phase === 'ALLOCATION') {
                        let html = `
                            <div class="leader-dashboard">
                                <div class="corner tl"></div>
                                <div class="corner tr"></div>
                                <div class="corner bl"></div>
                                <div class="corner br"></div>
                                <h1>LEADER</h1>
                                <p class="leader-sub-header">Supreme Commander // Allocation Protocol</p>

                                <div class="pool-display" id="pool-box">
                                    <span class="pool-label">TREASURY RESERVES</span>
                                    <span id="pool-remaining" class="pool-value">100</span>
                                </div>
                                
                                <div class="allocation-form">
                                    <h3 class="section-title">Personal Reserve (Max 10)</h3>
                                    <div class="allocation-item">
                                        <div class="label-row"><span>The Leader (You)</span></div>
                                        <div class="control-row">
                                            <input type="range" class="resource-slider" id="slider-self" min="0" max="10" value="0" oninput="syncInputs(this, 'num-self'); updatePool()">
                                            <input type="number" class="dual-input" id="num-self" min="0" max="10" value="0" oninput="syncInputs(this, 'slider-self'); updatePool()">
                                        </div>
                                    </div>
                                    
                                    <h3 class="section-title">Elite Ministries</h3>
                        `;

                        // Elites
                        ['Military', 'Intelligence', 'Interior', 'Economy', 'Media'].forEach((role, idx) => {
                            html += `
                                <div class="allocation-item" style="animation-delay: ${0.1 + (idx * 0.1)}s">
                                    <div class="label-row"><span>${role}</span></div>
                                    <div class="control-row">
                                        <input type="range" class="resource-slider elite-slider" data-role="${role}" id="sld-${role}" min="0" max="100" value="0" oninput="syncInputs(this, 'num-${role}'); updatePool()">
                                        <input type="number" class="dual-input" id="num-${role}" min="0" max="100" value="0" oninput="syncInputs(this, 'sld-${role}'); updatePool()">
                                    </div>
                                </div>
                            `;
                        });

                        // Citizens
                        html += `<h3 class="section-title">Public Classes</h3>`;
                        ['Upper Class', 'Middle Class', 'Lower Class'].forEach((cls, idx) => {
                            const idKey = cls.replace(' ', '');
                            html += `
                                <div class="allocation-item" style="animation-delay: ${0.6 + (idx * 0.1)}s">
                                    <div class="label-row"><span>${cls}</span></div>
                                    <div class="control-row">
                                        <input type="range" class="resource-slider citizen-slider" data-class="${cls}" id="sld-${idKey}" min="0" max="100" value="0" oninput="syncInputs(this, 'num-${idKey}'); updatePool()">
                                        <input type="number" class="dual-input" id="num-${idKey}" min="0" max="100" value="0" oninput="syncInputs(this, 'sld-${idKey}'); updatePool()">
                                    </div>
                                </div>
                            `;
                        });

                        html += `<button id="btn-submit-alloc" class="btn-submit">CONFIRM BUDGET</button></div>`;

                        document.getElementById('role-content').innerHTML = html;
                        document.getElementById('btn-submit-alloc').onclick = submitAllocation;
                    }
                } else {
                    document.body.classList.remove('leader-mode'); // Ensure removal if switching roles/cleanup
                    const elite = msg.roles.elites.find(e => e.name === myName);
                    if (elite) {
                        myRoleText = `ELITE: ${elite.role}`;
                        myDetail = `Vote Weight: ${elite.weight}`;

                        if (msg.phase === 'VOTING') {
                            // Allocation Data from previous phase (passed in msg)
                            const alloc = msg.lastAllocation || { elites: {}, citizens: {} };
                            const myShare = alloc.elites[elite.role] || 0;

                            // Calculate Average of Others
                            let otherSum = 0;
                            let otherCount = 0;
                            Object.entries(alloc.elites).forEach(([r, val]) => {
                                if (r !== elite.role) { otherSum += val; otherCount++; }
                            });
                            const avgElite = otherCount > 0 ? Math.round(otherSum / otherCount) : 0;

                            // Calculate Citizen Average
                            let citSum = 0;
                            Object.values(alloc.citizens).forEach(v => citSum += v);
                            const avgCit = Math.round(citSum / 3); // 3 classes

                            // Dynamic Theme Color
                            const roleColors = {
                                'Military': '#b30000',
                                'Intelligence': '#00bcd4',
                                'Interior': '#7b1fa2',
                                'Economy': '#4caf50',
                                'Media': '#ff9800'
                            };
                            const themeColor = roleColors[elite.role] || '#fff';
                            document.documentElement.style.setProperty('--elite-color', themeColor);

                            // Leader Gain (Assumed from msg or default)
                            const leaderGain = alloc.leaderSelf || 0;

                            document.getElementById('role-content').innerHTML = `
                                <div class="section-header" style="color: #ccc; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 5px; margin-bottom: 25px;">RESOURCE ALLOCATION</div>
                                
                                <div class="comparison-chart">
                                    <!-- YOU -->
                                    <div class="chart-row row-you">
                                        <span class="chart-label">YOU</span>
                                        <div class="chart-bar-bg"><div class="chart-bar-fill" style="width: ${myShare}%"></div></div>
                                        <span class="chart-value">${myShare}%</span>
                                    </div>
                                    <!-- LEADER -->
                                    <div class="chart-row row-leader">
                                        <span class="chart-label">LEADER</span>
                                        <div class="chart-bar-bg"><div class="chart-bar-fill" style="width: ${leaderGain}%"></div></div>
                                        <span class="chart-value">${leaderGain}%</span>
                                    </div>
                                    <!-- PEERS -->
                                    <div class="chart-row row-peers">
                                        <span class="chart-label">PEERS</span>
                                        <div class="chart-bar-bg"><div class="chart-bar-fill" style="width: ${avgElite}%"></div></div>
                                        <span class="chart-value">${avgElite}%</span>
                                    </div>
                                    <!-- MASSES -->
                                    <div class="chart-row row-masses">
                                        <span class="chart-label">MASSES</span>
                                        <div class="chart-bar-bg"><div class="chart-bar-fill" style="width: ${avgCit}%"></div></div>
                                        <span class="chart-value">${avgCit}%</span>
                                    </div>
                                </div>
                                
                                <!-- CHAT ROOM -->
                                <div class="section-header" style="margin-top: 50px; color:#ccc;">SECRET COUNCIL CHANNEL</div>
                                <div id="elite-chat" style="border: 1px solid var(--elite-color); background: rgba(0,0,0,0.4); padding: 15px;">
                                    <div id="chat-messages" style="height: 150px; overflow-y: auto; margin-bottom: 10px; font-family: 'Roboto Mono'; font-size: 0.8rem; scrollbar-width: thin; scrollbar-color: var(--elite-color) #000;">
                                        <!-- Messages will be appended here -->
                                        <div style="color:#666; font-style:italic;">Secure channel established...</div>
                                    </div>
                                    <div style="display: flex; gap: 10px;">
                                        <input type="text" id="chat-input" placeholder="Transmit Encrypted Message..." style="flex-grow: 1; background: rgba(0,0,0,0.5); border: 1px solid #555; color: #fff; padding: 10px; font-family: 'Roboto Mono';">
                                        <button onclick="sendChat()" style="background: var(--elite-color); color: #000; border: none; padding: 0 20px; font-family: 'Cinzel'; font-weight: bold; cursor: pointer;">SEND</button>
                                    </div>
                                </div>

                                <div class="section-header" style="margin-top: 50px; color:#ccc;">STRATEGIC DECISION</div>
                                
                                <div class="vote-buttons">
                                    <button class="btn-vote" onclick="requestVote('LOYAL')">LOYAL</button>
                                    <button class="btn-vote btn-betray" onclick="document.getElementById('coup-options').style.display='block'">BETRAY</button>
                                </div>
                                
                                <!-- SPLIT BETRAYAL OPTIONS -->
                                <div id="coup-options" style="display:none; margin-top:20px; animation: fadeIn 0.5s;">
                                    <div style="display: flex; gap: 15px;">
                                        
                                        <!-- OPTION 1: NO CONFIDENCE -->
                                        <div style="flex: 1; border: 1px solid #ff3d00; padding: 15px; background: rgba(50,0,0,0.3); display: flex; flex-direction: column; justify-content: space-between;">
                                            <div>
                                                <h4 style="color: #ff3d00; margin: 0 0 10px 0; font-size: 0.9rem; border-bottom: 1px solid #ff3d00; padding-bottom: 5px;">OPTION 1: DISSENT</h4>
                                                <p style="font-size: 0.8rem; color: #ccc; font-family: 'Roboto Mono'; line-height: 1.4;">
                                                    Vote No Confidence. Revolt without a leader.
                                                </p>
                                            </div>
                                            <button class="btn-vote btn-betray" style="width:100%; font-size: 0.9rem; padding: 10px; margin-top: 15px;" onclick="requestVote('BETRAY_SIMPLE')">VOTE NO CONFIDENCE</button>
                                        </div>

                                        <!-- OPTION 2: COUP -->
                                        <div style="flex: 1; border: 1px solid #fff; padding: 15px; background: rgba(255,255,255,0.05); display: flex; flex-direction: column; justify-content: space-between;">
                                             <div>
                                                <h4 style="color: #fff; margin: 0 0 10px 0; font-size: 0.9rem; border-bottom: 1px solid #fff; padding-bottom: 5px;">OPTION 2: COUP</h4>
                                                <p style="font-size: 0.8rem; color: #ccc; font-family: 'Roboto Mono'; line-height: 1.4; margin-bottom: 10px;">
                                                    Nominate a replacement. Rally support.
                                                </p>
                                                <select id="candidate-select" class="candidate-select" style="width:100%; padding:8px; background:#000; color:#fff; border:1px solid #555; font-family:'Cinzel'; font-size: 0.8rem;">
                                                    <option value="My Faction">My Faction (Me)</option>
                                                    ${msg.roles.elites.filter(e => e.name !== myName).map(e => `<option value="${e.role}">${e.role}</option>`).join('')}
                                                </select>
                                            </div>
                                            <button class="btn-vote" style="width:100%; border-color: #fff; color: #fff; font-size: 0.9rem; padding: 10px; margin-top: 15px;" onclick="initiateCoup()">DECLARE COUP</button>
                                        </div>

                                    </div>
                                </div>
                            `;
                        } else {
                            content = `<p class="wait-message" style="font-size:1rem;">Waiting for Leader Allocation...</p>`;
                        }
                    } else {
                        const citizen = msg.roles.citizens.find(c => c.name === myName);
                        if (citizen) {
                            myRoleText = "CITIZEN";
                            myDetail = `Class: ${citizen.class}`;

                            // Theme Application
                            document.body.classList.remove('theme-upper', 'theme-middle', 'theme-lower');
                            if (citizen.class === 'Upper Class') document.body.classList.add('theme-upper');
                            if (citizen.class === 'Middle Class') document.body.classList.add('theme-middle');
                            if (citizen.class === 'Lower Class') document.body.classList.add('theme-lower');

                            // Allocation Data for Stats
                            const alloc = msg.lastAllocation ? msg.lastAllocation : {
                                citizens: { 'Upper Class': 0, 'Middle Class': 0, 'Lower Class': 0 },
                                elites: {},
                                leaderSelf: 0
                            };

                            // Calculate Stats
                            const myGain = alloc.citizens[citizen.class] || 0;
                            const citTotal = Object.values(alloc.citizens).reduce((a, b) => a + b, 0);
                            const eliteTotal = Object.values(alloc.elites).reduce((a, b) => a + b, 0);
                            const leaderGain = alloc.leaderSelf || 0;

                            content = `
                                <div id="citizen-active-interface">
                                    <div class="stats-container">
                                        <div class="stat-item"><span class="stat-label">YOUR GAIN</span><span class="stat-value" id="val-ind">${myGain}%</span></div>
                                        <div class="stat-item"><span class="stat-label">CITIZEN TOTAL</span><span class="stat-value" id="val-cit">${citTotal}%</span></div>
                                        <div class="stat-item"><span class="stat-label">ELITE TOTAL</span><span class="stat-value" id="val-elite">${eliteTotal}%</span></div>
                                        <div class="stat-item"><span class="stat-label">LEADER GAIN</span><span class="stat-value" id="val-lead">${leaderGain}%</span></div>
                                    </div>

                                    <p style="color: #aaa; font-style: italic; margin-bottom: 20px; font-size: 1.0rem;">
                                        "The hierarchy is absolute. Your compliance is mandatory."
                                    </p>

                                    <div class="action-row">
                                        <button id="btn-accept" class="btn-action btn-accept" onclick="handleCitizenChoice('accept')">ACCEPT</button>
                                        <button id="btn-protest" class="btn-action btn-protest" onclick="handleCitizenChoice('protest')">PROTEST</button>
                                    </div>
                                    <div id="status-msg" style="margin-top:20px; height:20px; font-family:'Cinzel'; letter-spacing:3px;"></div>
                                </div>

                                <!-- WAITING SCREEN -->
                                <div id="waiting-screen">
                                    <div class="status-ring"></div>
                                    <div class="waiting-text">AWAITING REGIME</div>
                                    <p style="color:#888; letter-spacing:2px; margin-top:10px;">CONSENSUS PENDING</p>
                                </div>

                                <!-- OUTCOME: PURGED (Protested & Regime Won) -->
                                <div id="result-purged" class="outcome-screen">
                                    <h1 style="color: #ff0000; text-shadow: 0 0 20px #ff0000; font-size: 3.5rem;">ELIMINATED</h1>
                                    <p style="color: #fff; max-width: 600px; line-height: 1.6;">
                                        YOUR DEFIANCE HAS BEEN SILENCED.<br>
                                        <span style="font-size: 0.9rem; color: #888; display: block; margin-top: 10px;">
                                            Thank you for participating. You have been removed from the current session.<br>
                                            Please wait for a new session to begin to rejoin.
                                        </span>
                                    </p>
                                    <div class="icon-container" style="color:#ff0000; filter: drop-shadow(0 0 15px #ff0000);">
                                        <!-- Standard Skull SVG -->
                                        <svg width="120" height="120" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M12 2c-4 0-8 3-8 9 0 3.5 1.5 6 3 7.5V21h10v-2.5c1.5-1.5 3-4 3-7.5 0-6-4-9-8-9z"></path>
                                            <path d="M9 13a1 1 0 1 0 2 0 1 1 0 0 0-2 0"></path>
                                            <path d="M13 13a1 1 0 1 0 2 0 1 1 0 0 0-2 0"></path>
                                            <path d="M12 17v.01"></path>
                                            <path d="M10 17v.01"></path>
                                            <path d="M14 17v.01"></path>
                                        </svg>
                                    </div>
                                    <div style="margin-top: 30px; padding: 10px 20px; border: 1px solid #333; color: #555; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 2px;">
                                        CONNECTION TERMINATED
                                    </div>
                                </div>

                                <!-- OUTCOME: REGIME VICTORY (Obeyed & Regime Won) -->
                                <div id="result-victory" class="outcome-screen">
                                    <h1 style="color: #ffd700; text-shadow: 0 0 20px #d4af37;">ORDER PREVAILS</h1>
                                    <p style="color: #d4af37;">LOYALTY IS REWARDED</p>
                                    <div class="icon-container" style="color:#ffd700; filter: drop-shadow(0 0 15px #ffd700);">
                                        <!-- Premium Scales SVG -->
                                        <svg width="120" height="120" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M12 2v20"></path>
                                            <path d="M5 6l7-3 7 3"></path>
                                            <path d="M5 6c0 4 .5 10 7 13 6.5-3 7-9 7-13"></path>
                                            <path d="M12 3v3"></path>
                                            <path d="M8 9h8"></path>
                                            <path d="M8 9l-2 5h4l-2-5"></path>
                                            <path d="M16 9l-2 5h4l-2-5"></path>
                                        </svg>
                                    </div>
                                    <button class="btn-lobby" onclick="alert('Redirecting to Lobby...')">PROCEED TO ROUND 2</button>
                                </div>

                                <!-- OUTCOME: REVOLUTION (Leader Lost) -->
                                <div id="result-revolution" class="outcome-screen">
                                    <h1 style="color: #fff; text-shadow: 0 0 20px #00e5ff;">TYRANT FALLEN</h1>
                                    <p style="color: #00e5ff;">A NEW ERA BEGINS</p>
                                    <div class="icon-container" style="color:#00e5ff; filter: drop-shadow(0 0 15px #00e5ff);">
                                        <!-- Premium Flame SVG -->
                                        <svg width="120" height="120" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.6-3.3.3.6.4 1.5.9 2.8z"></path>
                                            <path d="M12 22v-1"></path>
                                        </svg>
                                    </div>
                                    <button class="btn-lobby" onclick="alert('Redirecting to Lobby...')">PROCEED TO ROUND 2</button>
                                </div>
                            `;
                        }
                    }
                }


                // Only update if content changed or first render
                // Only update if content changed or first render
                const container = document.getElementById('role-content');

                // Construct Header
                const header = `
                    <h1 style="color: #ffd700;">${myRoleText}</h1>
                    <p>${myDetail}</p>
                    <hr style="border-color: #333; margin: 2vh 0;">
                    <p>Round: ${msg.round} | Phase: ${msg.phase}</p>
                `;

                // Combine and Render
                if (content) container.innerHTML = header + content;
            }
        };

        // Client-side Logic
        function updatePool() {
            const sliders = document.querySelectorAll('.resource-slider');
            let total = 0;
            sliders.forEach(s => {
                const val = parseInt(s.value);
                // Update label
                s.parentElement.querySelector('.allocation-label span:last-child').innerText = val;
                total += val;
            });

            const remaining = 100 - total;
            const poolEl = document.getElementById('pool-remaining');
            poolEl.innerText = remaining;

            // Simple validation visual
            if (remaining < 0) poolEl.style.color = 'red';
            else poolEl.style.color = '#4CAF50';
        }

        // --- Citizen Experience Logic ---
        function handleCitizenChoice(type) {
            const btnAccept = document.getElementById('btn-accept');
            const btnProtest = document.getElementById('btn-protest');
            const status = document.getElementById('status-msg');
            const accentColor = getComputedStyle(document.body).getPropertyValue('--accent-color');

            if (navigator.vibrate) navigator.vibrate(100);

            // Record Choice Locally for Outcome Handling
            window.myProtestStatus = type; // 'accept' or 'protest'

            // Send to Server
            if (type === 'protest') {
                channel.send({ type: 'PROTEST', sender: myName });
            }

            // 1. Trigger Animation
            if (type === 'accept') {
                btnProtest.classList.add('fade-out');
                btnAccept.classList.add('move-center-from-left');
                setTimeout(() => {
                    btnAccept.innerText = "OBEYED";
                    status.innerText = "COMPLIANCE REGISTERED";
                    status.style.color = accentColor;
                }, 300);
            } else {
                btnAccept.classList.add('fade-out');
                btnProtest.classList.add('move-center-from-right');
                setTimeout(() => {
                    const glitch = setInterval(() => { btnProtest.innerText = Math.random() > 0.5 ? "RIOT" : "NO!"; }, 50);
                    setTimeout(() => {
                        clearInterval(glitch);
                        btnProtest.innerText = "SENT";
                        status.innerText = "SIGNAL TRANSMITTED";
                        status.style.color = accentColor;
                    }, 400);
                }, 300);
            }

            // 2. Wait, then Transition to Waiting Screen
            setTimeout(() => {
                const activeInterface = document.getElementById('citizen-active-interface');
                const waitingScreen = document.getElementById('waiting-screen');

                activeInterface.style.opacity = '0';
                activeInterface.style.transition = 'opacity 1s';

                setTimeout(() => {
                    activeInterface.style.display = 'none';
                    waitingScreen.style.display = 'flex';
                    // Force reflow
                    void waitingScreen.offsetWidth;
                    waitingScreen.style.opacity = '1';
                }, 1000);

            }, 2500);
        }

        function submitAllocation() {
            const remaining = parseInt(document.getElementById('pool-remaining').innerText);
            if (remaining < 0) {
                alert("You have exceeded the resource pool!");
                return;
            }

            const allocation = {
                leader: parseInt(document.getElementById('slider-self').value),
                elites: {},
                citizens: {}
            };

            document.querySelectorAll('.elite-slider').forEach(s => {
                allocation.elites[s.dataset.role] = parseInt(s.value);
            });

            document.querySelectorAll('.citizen-slider').forEach(s => {
                allocation.citizens[s.dataset.class] = parseInt(s.value);
            });

            channel.postMessage({ type: 'ALLOCATION_SUBMIT', data: allocation });
            document.getElementById('role-content').innerHTML = "<p>Allocation Submitted. Waiting for Voting...</p>";
        }

        function showCoupOptions() {
            document.getElementById('coup-options').classList.remove('hidden');
        }

        function submitVote(choice) {
            let candidate = null;
            if (choice === 'BETRAY') {
                candidate = document.getElementById('candidate-select').value;
            }

            channel.postMessage({
                type: 'VOTE_SUBMIT',
                vote: choice,
                candidate: candidate, // Name of the elite they want to promote
                voter: myName
            });

            document.getElementById('role-content').innerHTML = "<p>Vote Locked. Awaiting Resolution...</p>";
        }
        // Helper Functions for New UI
        function syncInputs(source, targetId) {
            const target = document.getElementById(targetId);
            if (target) target.value = source.value;
        }

        let wasOverBudget = false;

        function updatePool() {
            // New logic for dual inputs
            const inputs = document.querySelectorAll('input[type="number"].dual-input');
            let total = 0;
            inputs.forEach(inp => total += parseInt(inp.value || 0));

            // If no dual inputs found (legacy safety), use ranges
            if (inputs.length === 0) {
                document.querySelectorAll('input[type="range"]').forEach(r => total += parseInt(r.value || 0));
            }

            const remaining = 100 - total;
            const el = document.getElementById('pool-remaining');
            const box = document.getElementById('pool-box');

            if (el) el.innerText = remaining;

            if (remaining < 0) {
                if (el) {
                    el.style.color = '#ff3333';
                    el.style.textShadow = '0 0 10px #ff3333';
                }
                if (box) box.classList.add('error');

                // HAPTIC FEEDBACK
                if (!wasOverBudget) {
                    if (navigator.vibrate) navigator.vibrate(200);
                    if (box) {
                        box.style.animation = 'none';
                        box.offsetHeight; /* trigger reflow */
                        box.style.animation = 'shake 0.5s';
                    }
                    wasOverBudget = true;
                }
            } else {
                if (el) {
                    el.style.color = '#4CAF50';
                    el.style.textShadow = '0 0 10px rgba(76, 175, 80, 0.5)';
                }
                if (box) box.classList.remove('error');
                wasOverBudget = false;
            }
        }

        // Submit Logic (Adapted)
        function submitAllocation() {
            const allocation = {
                leaderSelf: parseInt(document.getElementById('num-self').value || 0),
                elites: {},
                citizens: {}
            };

            document.querySelectorAll('.elite-slider').forEach(sl => {
                // Read from sibling number input if possible, or slider data
                const role = sl.dataset.role;
                const numInput = document.getElementById('num-' + role);
                allocation.elites[role] = parseInt(numInput ? numInput.value : sl.value);
            });

            document.querySelectorAll('.citizen-slider').forEach(sl => {
                const cls = sl.dataset.class;
                const idKey = cls.replace(' ', '');
                const numInput = document.getElementById('num-' + idKey);
                allocation.citizens[cls] = parseInt(numInput ? numInput.value : sl.value);
            });

            // Validate total
            let total = allocation.leaderSelf;
            Object.values(allocation.elites).forEach(v => total += v);
            Object.values(allocation.citizens).forEach(v => total += v);

            if (total > 100) {
                alert("Budget Exceeded! Reduce allocation.");
                return;
            }

            console.log("Submitting Allocation:", allocation);
            channel.send({
                type: 'ALLOCATION_SUBMIT',
                role: 'leader',
                name: myName,
                allocation: allocation
            });

            // Show new Waiting State (Post-Submit)
            document.getElementById('role-content').innerHTML = `
                <div class="leader-dashboard" style="text-align:center; padding-top:10vh;">
                    <div class="corner tl"></div>
                    <div class="corner tr"></div>
                    <div class="corner bl"></div>
                    <div class="corner br"></div>
                    <h1 style="font-size:3em; animation: pulse 2s infinite;">AWAITING COUNCIL</h1>
                    <p class="leader-sub-header">Transmission Encrypted. Standby.</p>
                    <div class="loader" style="margin: 5vh auto; border-color: #d4af37;"></div>
                </div>
            `;
        }
        // --- LEADER JUDGMENT HELPERS ---
        let judgments = 0;
        function checkProgress() {
            judgments++;
            if (judgments >= 1) {
                const btn = document.getElementById('btn-next');
                if (btn) btn.style.display = 'block';
            }
        }

        function executeTrait(cardId) {
            const card = document.getElementById(cardId);
            const container = document.getElementById('main-content');
            if (container) {
                container.style.animation = 'none';
                container.offsetHeight;
                container.style.animation = 'shakeScreen 0.3s';
            }
            if (card) card.classList.add('executed');
            if (navigator.vibrate) navigator.vibrate(200);
            checkProgress();
        }

        function pardonTrait(cardId) {
            const card = document.getElementById(cardId);
            if (card) card.classList.add('pardoned');
            checkProgress();
        }

        /* ========================
           ELITE LOGIC EXTENSIONS
           ======================== */

        // Global Pending Action
        let pendingVoteType = null;
        let pendingCandidate = null;

        // Step 1: Request Vote -> Opens Confirmation
        function requestVote(type, candidate = null) {
            pendingVoteType = type;
            pendingCandidate = candidate;

            const modal = document.getElementById('confirmation-modal');
            const box = document.getElementById('confirm-box-content');
            const title = document.getElementById('confirm-title');
            const desc = document.getElementById('confirm-desc');
            const btn = document.getElementById('confirm-yes-btn');

            // Customize Confirmation based on Type
            modal.style.display = 'flex';

            if (type === 'LOYAL') {
                box.style.borderColor = 'var(--elite-color)';
                title.innerText = "CONFIRM LOYALTY";
                desc.innerText = "You are voting to support the current Leader. This will maintain the status quo.";
                btn.innerText = "PLEDGE LOYALTY";
                btn.style.color = "var(--elite-color)";
                btn.style.borderColor = "var(--elite-color)";
                btn.style.background = "rgba(0,0,0,0.8)";
            } else if (type === 'BETRAY_SIMPLE') {
                box.style.borderColor = '#ff3d00';
                title.innerText = "CONFIRM DISSENT";
                title.style.color = "#ff3d00";
                desc.innerText = "You are voting 'No Confidence'. This is an act of rebellion.";
                btn.innerText = "VOTE NO CONFIDENCE";
                btn.style.color = "#ff3d00";
                btn.style.borderColor = "#ff3d00";
            } else if (type === 'BETRAY_COUP') {
                box.style.borderColor = '#ff0000';
                title.innerText = "INITIATE COUP";
                title.style.color = "#ff0000";
                desc.innerHTML = `You are formally nominating <strong>${candidate.toUpperCase()}</strong>.<br>This will alert all other Elites immediately.`;
                btn.innerText = "DECLARE COUP";
                btn.style.color = "#fff";
                btn.style.background = "#b30000";
                btn.style.borderColor = "#ff0000";
            } else if (type === 'EXTERNAL') {
                box.style.borderColor = '#ff0000';
                title.innerText = "ACCEPT FOREIGN OFFER";
                title.style.color = "#ff0000";
                desc.innerHTML = `You are accepting foreign resources to overthrow the state.<br><strong>THIS IS TREASON.</strong>`;
                btn.innerText = "COMMIT TREASON";
                btn.style.color = "#fff";
                btn.style.background = "#ff0000";
                btn.style.borderColor = "#fff";
                btn.style.boxShadow = "0 0 20px #ff0000";
            } else if (type === 'SUPPORT') {
                box.style.borderColor = '#ff9800';
                title.innerText = "CONFIRM ALLIANCE";
                title.style.color = "#ff9800";
                desc.innerHTML = `You are pledging your full support to the coup.<br>Allied Weight will be added.`;
                btn.innerText = "JOIN ALLIANCE";
                btn.style.color = "#ff9800";
                btn.style.background = "transparent";
                btn.style.borderColor = "#ff9800";
            }
        }

        // Step 2: Confirm Action -> Executes Logic
        function confirmAction() {
            document.getElementById('confirmation-modal').style.display = 'none';
            executeVote(pendingVoteType, pendingCandidate);
        }

        // Step 3: Execute Logic
        function executeVote(type, candidate) {

            // Logic for Coup Broadcast
            if (type === 'BETRAY_COUP') {
                // Broadcast Alert
                channel.send({
                    type: 'COUP_ALERT',
                    initiator: myName,
                    candidate: candidate
                });
                // Send Vote
                channel.send({
                    type: 'VOTE_SUBMIT',
                    role: 'elite',
                    name: myName, // Server needs to look up role
                    vote: 'BETRAY',
                    coupType: 'COUP',
                    candidate: candidate
                });
            } else if (type === 'SUPPORT') {
                // Send Support Vote
                channel.send({
                    type: 'VOTE_SUBMIT',
                    role: 'elite',
                    name: myName,
                    vote: 'BETRAY', // Support counts as Betrayal of leader? Or new type? Assume Betray for now.
                    coupType: 'SUPPORT',
                    candidate: candidate
                });
            } else if (type === 'EXTERNAL') {
                channel.send({
                    type: 'VOTE_SUBMIT',
                    role: 'elite',
                    name: myName,
                    vote: 'BETRAY',
                    coupType: 'EXTERNAL'
                });
            } else if (type === 'BETRAY_SIMPLE') {
                channel.send({
                    type: 'VOTE_SUBMIT',
                    role: 'elite',
                    name: myName,
                    vote: 'BETRAY',
                    coupType: 'SIMPLE'
                });
            } else {
                // LOYAL
                channel.send({
                    type: 'VOTE_SUBMIT',
                    role: 'elite',
                    name: myName,
                    vote: 'LOYAL'
                });
            }

            // Hide Dashboard, Show Waiting
            document.getElementById('role-content').style.display = 'none';
            document.getElementById('external-offer-modal').style.display = 'none';
            document.getElementById('waiting-screen-elite').style.display = 'flex';
        }

        // Helper to trigger request logic
        function initiateCoup() {
            const candidate = document.getElementById('candidate-select').value;
            requestVote('BETRAY_COUP', candidate);
        }

        function confirmSupport(candidate) {
            // Immediately request support confirmation
            requestVote('SUPPORT', candidate);
        }

        function sendChat() {
            const input = document.getElementById('chat-input');
            const msg = input.value;
            if (!msg) return;

            // Optimistic Update
            const chatBox = document.getElementById('chat-messages');
            if (chatBox) {
                const newLine = document.createElement('div');
                newLine.style.marginBottom = '5px';
                newLine.innerHTML = `<span style="color: var(--elite-color); font-weight: bold;">[YOU]:</span> ${msg}`;
                chatBox.appendChild(newLine);
                chatBox.scrollTop = chatBox.scrollHeight;
            }

            // Send Network Message
            channel.send({
                type: 'CHAT_MESSAGE',
                role: 'elite', // Need exact role name? Server knows.
                sender: myName,
                text: msg
            });

            input.value = '';
        }

        function goToLobby() {
            document.getElementById('role-content').innerHTML = `
                <div class="lobby-state" style="margin-top:10vh;">
                    <div class="lobby-spinner" style="width:50px; height:50px; border:3px solid #333; border-top:3px solid #d4af37; border-radius:50%; animation:spin 1s infinite; margin:0 auto 20px auto;"></div>
                    <h1 style="font-family:'Cinzel Decorative'; color:#d4af37;">STANDING BY</h1>
                    <p style="color:#aaa; letter-spacing:2px; margin-top:10px;">Awaiting Next Crisis...</p>
                </div>
            `;
            // Optional: Send "READY" to engine
            // channel.send({type: 'LEADER_READY'}); 
        }
    </script>
    <script src="background_anim.js"></script>
</body>

</html>